"use strict";var _createClass=function(){function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}();function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function i(){_classCallCheck(this,i)}return _createClass(i,null,[{key:"getParameterByName",value:function(e,n){n||(n=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var t=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(n);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}},{key:"fetchRestaurants",value:function(){return navigator.onLine?fetch(i.RESTAURANT_API).then(function(e){return e.json()}).then(function(e){return i.createIDBStore(e,i.RESTAURANT_IDB_NAME,i.RESTAURANT_IDB_STORE_NAME),e}).catch(function(e){return console.error("ERR_FETCHING_RESTAURANTS: "+e)}):new Promise(function(n,e){i.getCachedData(i.RESTAURANT_IDB_NAME,i.RESTAURANT_IDB_STORE_NAME).then(function(e){return n(e)}).catch(function(e){return console.warn("ERR_FETCHING_CACHED_RESTAURANTS: "+e.message)})})}},{key:"addRestaurantToFavorites",value:function(e,n,t){fetch(i.DATABASE_URL+"/restaurants/"+e+"/?is_favorite="+n,{method:"put"}).then(function(e){return t(null,1)}).catch(function(e){return t(e,null)})}},{key:"fetchRestaurantById",value:function(n){return i.fetchRestaurants().then(function(e){return e.find(function(e){return e.id==n})}).then(function(e){return e}).catch(function(e){return console.error("ERR_FETCHING_RESTAURANT_BY_ID: "+e)})}},{key:"fetchRestaurantByCuisine",value:function(n){return i.fetchRestaurants().then(function(e){return e.filter(function(e){return e.cuisine_type==n})}).then(function(e){return e}).catch(function(e){return console.error("ERR_FETCHING_RESTAURANT_BY_CUISINE: "+e)})}},{key:"fetchRestaurantByNeighborhood",value:function(n){return i.fetchRestaurants().then(function(e){return e.filter(function(e){return e.neighborhood==n})}).then(function(e){return e}).catch(function(e){return console.error("ERR_FETCHING_RESTAURANT_BY_NEIGHBOURHOOD: "+e)})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(t,r){return i.fetchRestaurants().then(function(e){var n=e;return"all"!=r&&(n=e.filter(function(e){return e.cuisine_type==r})),"all"!=t&&(n=e.filter(function(e){return e.neighborhood==t})),n}).catch(function(e){return console.error("ERR_FETCHING_RESTAURANT_BY_CUISINE_NEIGHBOURHOOD: "+e)})}},{key:"fetchReviews",value:function(){return navigator.onLine?fetch(i.REVIEWS_API).then(function(e){return e.json()}).then(function(e){return i.createIDBStore(e,i.REVIEWS_IDB_NAME,i.REVIEWS_IDB_STORE_NAME),e}).catch(function(e){return console.error("ERR_FETCHING_ALL_REVIEWS: "+e)}):new Promise(function(n,e){i.getCachedData(i.REVIEWS_IDB_NAME,i.REVIEWS_IDB_STORE_NAME).then(function(e){return n(e)}).catch(function(e){return console.error("ERR_FETCHING_REVIEWS_FROM_IDB: "+e)})})}},{key:"fetchReviewsByRestaurantId",value:function(n){return i.fetchReviews().then(function(e){return e.filter(function(e){return e.restaurant_id==n})}).then(function(e){return navigator.onLine?fetch(i.RESTAURANT_REVIEWS_API).then(function(e){return e.json()}).catch(function(e){return console.err("ERR_FETCHING_REVIEW: "+e)}):e}).catch(function(e){return console.error("ERR_FETCH_REVIEWS_BY_RESTAURANT_ID: "+e)})}},{key:"fetchNeighborhoods",value:function(){return i.fetchRestaurants().then(function(t){var r=t.map(function(e,n){return t[n].neighborhood});return r.filter(function(e,n){return r.indexOf(e)==n})}).catch(function(e){return console.error("ERR_FETCHING_NEIGHBORHOODS: "+e)})}},{key:"fetchCuisines",value:function(){return i.fetchRestaurants().then(function(t){var r=t.map(function(e,n){return t[n].cuisine_type});return r.filter(function(e,n){return r.indexOf(e)==n})}).catch(function(e){return console.error("ERR_FETCHING_CUISINES: "+e)})}},{key:"createIDBStore",value:function(r,e,o){var u=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(e,1);u.onupgradeneeded=function(){u.result.createObjectStore(o,{keyPath:"id"}).createIndex("by-id","id")},u.onerror=function(e){console.error("IndexedDB error: "+e.target.errorCode)},u.onsuccess=function(){var e=u.result,n=e.transaction(o,"readwrite"),t=n.objectStore(o);t.index("by-id");r.forEach(function(e){return t.put(e)}),n.oncomplete=function(){e.close()}}}},{key:"cacheObject",value:function(r,o,u){var c=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(o,1);c.onupgradeneeded=function(){var e=c.result,n={keyPath:"id"};if(o==i.REVIEWS_OFFLINE_IDB_NAME){n={keyPath:void 0,unique:!1,autoIncrement:!1};e.createObjectStore(u,n)}else e.createObjectStore(u,n).createIndex("by-id","id")},c.onerror=function(e){console.error("IndexedDB error: "+e.target.errorCode)},c.onsuccess=function(){var e=c.result,n=e.transaction(u,"readwrite"),t=n.objectStore(u);if(o==i.REVIEWS_OFFLINE_IDB_NAME)t.put(r,1);else{t.index("by-id");t.put(r)}n.oncomplete=function(){e.close()}}}},{key:"getCachedData",value:function(n,u){return new Promise(function(r,e){var o=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(n,1);o.onsuccess=function(){var e=o.result,n=e.transaction(u,"readwrite"),t=n.objectStore(u).getAll();t.onsuccess=function(){r(t.result)},n.oncomplete=function(){e.close()}}})}},{key:"clearStore",value:function(e,n){var t=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(e,1);t.onsuccess=function(){t.result.transaction(n,"readwrite").objectStore(n).clear()},tx.oncomplete=function(){db.close()}}},{key:"mapMarkerForRestaurant",value:function(e,n){return new google.maps.Marker({position:e.latlng,title:e.name,url:i.urlForRestaurant(e),map:n,animation:google.maps.Animation.DROP})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return void 0===e?"/dist/img/no_image.webp":"/dist/img/"+e.photograph+".webp"}},{key:"lazyLoad",value:function(){"undefined"!=typeof LazyLoad&&new LazyLoad({elements_selector:".restaurant-img"})}},{key:"getRestaurantByIdApiUrl",value:function(e){return"http://localhost:"+i.PORT+"/restaurants/"+e}},{key:"postReview",value:function(e){return fetch(i.REVIEWS_API,{method:"post",body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){return i.cacheObject(e,i.REVIEWS_IDB_NAME,i.REVIEWS_IDB_STORE_NAME),e}).catch(function(e){return console.error("ERROR_POSTING_REVIEW: "+e)})}},{key:"postCachedReviews",value:function(){if(navigator.onLine)return new Promise(function(e,n){i.getCachedData(i.REVIEWS_OFFLINE_IDB_NAME,i.REVIEWS_OFFLINE_STORE_NAME).then(function(e){e.forEach(function(e){i.postReview(e).then(function(e){document.getElementById("form-legend").innerHTML="Your Review Has Been Saved, Thanks For Sharing Your Thoughts!!!",document.getElementById("reviews-form").reset(),console.log("SAVED_REVIEW: "+e)})})}).then(function(){return i.clearStore(i.REVIEWS_OFFLINE_IDB_NAME,i.REVIEWS_OFFLINE_STORE_NAME)}).catch(function(e){return console.error("ERROR_SAVING_CACHED_REVIEWS: "+e)})})}},{key:"PORT",get:function(){return 1337}},{key:"RESTAURANT_API",get:function(){return"http://localhost:"+i.PORT+"/restaurants"}},{key:"RESTAURANT_REVIEWS_API",get:function(){return"http://localhost:"+i.PORT+"/reviews/?restaurant_id="+i.getParameterByName("id")}},{key:"REVIEWS_API",get:function(){return"http://localhost:"+i.PORT+"/reviews/"}},{key:"RESTAURANT_IDB_NAME",get:function(){return"RestaurantDB"}},{key:"RESTAURANT_IDB_STORE_NAME",get:function(){return"RestaurantStore"}},{key:"REVIEWS_IDB_NAME",get:function(){return"ReviewsDB"}},{key:"REVIEWS_IDB_STORE_NAME",get:function(){return"ReviewsStore"}},{key:"REVIEWS_OFFLINE_IDB_NAME",get:function(){return"OfflineReviewsCacheDB"}},{key:"REVIEWS_OFFLINE_STORE_NAME",get:function(){return"OfflineReviewsCacheStoore"}}]),i}();